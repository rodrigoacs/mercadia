<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Mercadia</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%231e293b%22/><text y=%22.9em%22 font-size=%2280%22 x=%2250%22 text-anchor=%22middle%22 fill=%22%238b5cf6%22 font-family=%22serif%22 font-weight=%22bold%22>M</text></svg>"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root {
        --bg-app: #121212;
        --bg-panel: #1e1e1e;
        --border-color: #333333;
        --accent-primary: #6366f1;
        --text-main: #e0e0e0;
        --text-muted: #a0a0a0;
        --profit: #10b981;
        --loss: #ef4444;
      }

      body {
        background-color: var(--bg-app);
        color: var(--text-main);
        font-family: 'Inter', sans-serif;
        padding-bottom: 60px;
        -webkit-font-smoothing: antialiased;
      }

      .navbar {
        background-color: var(--bg-panel);
        border-bottom: 1px solid var(--border-color);
        padding: 0.8rem 0;
      }
      .navbar-brand {
        font-weight: 700;
        font-size: 1.1rem;
        color: #fff;
      }

      .search-container {
        position: relative;
        width: 100%;
        max-width: 300px;
      }
      .form-control-dark {
        background-color: #2d2d2d;
        border: 1px solid #444;
        color: #fff;
        font-size: 0.85rem;
        border-radius: 6px;
      }
      .form-control-dark:focus {
        background-color: #333;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.25);
        color: #fff;
      }

      .ui-panel {
        background-color: var(--bg-panel);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        height: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .panel-header {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .panel-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--text-muted);
        margin: 0;
      }
      .panel-body {
        padding: 15px;
        flex-grow: 1;
      }

      .big-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #fff;
        letter-spacing: -0.5px;
      }
      @media (min-width: 768px) {
        .big-number {
          font-size: 2.2rem;
        }
      }

      .table {
        margin-bottom: 0;
        --bs-table-bg: transparent;
      }
      .table th {
        border-bottom: 1px solid var(--border-color);
        font-size: 0.7rem;
        text-transform: uppercase;
        color: var(--text-muted);
        font-weight: 600;
        padding: 10px 15px;
      }
      .table td {
        border-bottom: 1px solid #2a2a2a;
        padding: 10px 15px;
        vertical-align: middle;
        font-size: 0.85rem;
        color: var(--text-main);
      }
      .table tr:last-child td {
        border-bottom: none;
      }

      .col-card-name {
        max-width: 130px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 600;
        color: #fff;
      }
      @media (min-width: 768px) {
        .col-card-name {
          max-width: 250px;
        }
      }

      .badge-tech {
        background: #2d2d2d;
        border: 1px solid #444;
        color: #ccc;
        font-weight: 500;
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
      }
      .badge-extra {
        background: linear-gradient(135deg, #3730a3, #4f46e5);
        border: 1px solid #6366f1;
        color: #fff;
        font-size: 0.6rem;
        text-transform: uppercase;
        padding: 2px 5px;
        border-radius: 4px;
      }
      .var-up {
        color: var(--profit);
        font-weight: 600;
      }
      .var-down {
        color: var(--loss);
        font-weight: 600;
      }
      .text-dim {
        color: var(--text-muted);
        font-size: 0.75rem;
      }

      .chart-container-main {
        position: relative;
        height: 250px;
        width: 100%;
      }
      @media (min-width: 768px) {
        .chart-container-main {
          height: 300px;
        }
      }

      .modal-content {
        background-color: var(--bg-panel);
        border: 1px solid var(--border-color);
      }
      .modal-header {
        border-bottom: 1px solid var(--border-color);
      }
      .modal-footer {
        border-top: 1px solid var(--border-color);
      }
      .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
      }
    </style>
  </head>
  <body>
    <nav class="navbar sticky-top">
      <div class="container px-3">
        <div class="d-flex align-items-center flex-grow-1">
          <span class="navbar-brand me-3 d-none d-sm-block">MERCADIA</span>
          <span class="navbar-brand me-3 d-block d-sm-none">MERCADIA</span>

          <div class="search-container me-auto">
            <form id="searchForm" onsubmit="realizarBusca(event)">
              <input
                type="text"
                id="searchInput"
                class="form-control form-control-dark"
                placeholder="Buscar carta..."
              />
            </form>
          </div>
        </div>

        <div class="text-end ms-2 d-none d-sm-block">
          <div class="text-dim" style="font-size: 0.65rem; text-transform: uppercase">
            Atualizado
          </div>
          <div style="font-size: 0.8rem; font-weight: 500" id="lastUpdate">--/--</div>
        </div>
      </div>
    </nav>

    <div class="modal fade" id="searchModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="searchModalTitle">Resultados</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body p-0">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Carta</th>
                    <th class="text-center">Set</th>
                    <th class="text-center">Qtd</th>
                    <th class="text-end">Total</th>
                  </tr>
                </thead>
                <tbody id="searchResultsBody"></tbody>
              </table>
            </div>
            <div id="noResults" class="text-center py-4 text-muted d-none">
              Nenhuma carta encontrada.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container mt-3 px-2">
      <div class="row g-2 mb-3">
        <div class="col-12 col-md-4">
          <div class="ui-panel">
            <div class="panel-body d-flex flex-column justify-content-center h-100">
              <span class="panel-title mb-1">Patrimônio Total</span>
              <div class="d-flex align-items-baseline">
                <span class="big-number me-2" id="kpiTotal">...</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-4">
          <div class="ui-panel">
            <div class="panel-body">
              <span class="panel-title">Volume</span>
              <div class="big-number mt-1" id="kpiQtd">...</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-4">
          <div class="ui-panel">
            <div class="panel-body">
              <span class="panel-title">Variação 24h</span>
              <div class="big-number mt-1" id="kpiVar">...</div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-12">
          <div class="ui-panel">
            <div class="panel-header"><span class="panel-title">Evolução</span></div>
            <div class="panel-body p-2">
              <div class="chart-container-main"><canvas id="mainChart"></canvas></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-12 col-lg-5">
          <div class="ui-panel h-100">
            <div class="panel-header"><span class="panel-title">Maiores Movimentações</span></div>
            <div class="table-responsive">
              <table class="table table-hover">
                <tbody id="tableMovers"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-7">
          <div class="ui-panel h-100">
            <div class="panel-header"><span class="panel-title">Top 10 Assets</span></div>
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th style="width: 30px">#</th>
                    <th>Carta</th>
                    <th class="text-center d-none d-md-table-cell">Set</th>
                    <th class="text-end">Total</th>
                  </tr>
                </thead>
                <tbody id="tableTop10"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const BRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' })
      Chart.defaults.font.family = "'Inter', sans-serif"
      Chart.defaults.color = '#A0A0A0'
      Chart.defaults.borderColor = '#333'

      async function realizarBusca(e) {
        e.preventDefault()
        const termo = document.getElementById('searchInput').value.trim()
        if (termo.length < 2) return

        const modalEl = document.getElementById('searchModal')
        const modal = new bootstrap.Modal(modalEl)
        modal.show()

        const tbody = document.getElementById('searchResultsBody')
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">Buscando...</td></tr>'
        document.getElementById('noResults').classList.add('d-none')

        try {
          const req = await fetch(`/api/busca?q=${encodeURIComponent(termo)}`)
          const resultados = await req.json()

          tbody.innerHTML = ''

          if (resultados.length === 0) {
            document.getElementById('noResults').classList.remove('d-none')
          } else {
            document.getElementById('noResults').classList.add('d-none')
            resultados.forEach(c => {
              const tr = document.createElement('tr')

              const extraBadge = c.extras ? `<span class="badge-extra ms-1">${c.extras}</span>` : ''
              const setBadge = `<span class="badge-tech">${c.edicao}</span>`
              const numDisplay = c.num ? `<span class="text-muted small ms-1">#${c.num}</span>` : ''

              tr.innerHTML = `
                        <td>
                            <div class="fw-bold text-white">${c.nome}</div>
                            <div class="d-block d-md-none mt-1">
                                ${setBadge} ${numDisplay} ${extraBadge}
                            </div>
                            <div class="d-none d-md-inline-block">
                                ${extraBadge}
                            </div>
                        </td>
                        <td class="text-center d-none d-md-table-cell">
                            ${setBadge}
                            <div class="mt-1">${numDisplay}</div>
                        </td>
                        <td class="text-center text-muted">${c.qtd}</td>
                        <td class="text-end fw-bold text-white">${BRL.format(c.total)}</td>
                    `
              tbody.appendChild(tr)
            })
          }

          document.getElementById('searchModalTitle').innerText = `Resultados para "${termo}"`
        } catch (error) {
          console.error(error)
          tbody.innerHTML =
            '<tr><td colspan="4" class="text-center text-danger py-3">Erro na busca.</td></tr>'
        }
      }

      async function initDashboard() {
        try {
          const req = await fetch('/api/dashboard')
          const data = await req.json()

          if (data.vazio) {
            document.getElementById('kpiTotal').innerText = 'R$ 0,00'
            return
          }

          document.getElementById('kpiTotal').innerText = BRL.format(data.kpis.totalValor)
          document.getElementById('kpiQtd').innerText = data.kpis.totalCartas

          const dataUpdate = data.kpis.dataAtualizacao.split('-')
          document.getElementById('lastUpdate').innerText = `${dataUpdate[2]}/${dataUpdate[1]}`

          const varVal = data.kpis.variacaoDia
          const varEl = document.getElementById('kpiVar')
          varEl.innerText = (varVal > 0 ? '+' : '') + BRL.format(varVal)
          varEl.className = 'big-number mt-1 ' + (varVal >= 0 ? 'var-up' : 'var-down')

          const ctxMain = document.getElementById('mainChart').getContext('2d')
          const gradientMain = ctxMain.createLinearGradient(0, 0, 0, 300)
          gradientMain.addColorStop(0, 'rgba(99, 102, 241, 0.2)')
          gradientMain.addColorStop(1, 'rgba(99, 102, 241, 0)')

          new Chart(ctxMain, {
            type: 'line',
            data: {
              labels: data.grafico.labels,
              datasets: [
                {
                  label: 'Total',
                  data: data.grafico.valores,
                  borderColor: '#6366f1',
                  borderWidth: 2,
                  backgroundColor: gradientMain,
                  fill: true,
                  tension: 0.2,
                  pointRadius: 0,
                  pointHitRadius: 20,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { display: false },
                y: {
                  border: { dash: [4, 4] },
                  grid: { color: '#2a2a2a' },
                  ticks: { callback: v => BRL.format(v) },
                },
              },
            },
          })

          const tbodyTop = document.getElementById('tableTop10')
          data.topValiosas.forEach((c, i) => {
            const tr = document.createElement('tr')
            const extraBadge = c.extras ? `<span class="badge-extra ms-1">${c.extras}</span>` : ''
            const setBadge = `<span class="badge-tech">${c.edicao}</span>`
            const numDisplay = c.num ? `<span class="text-muted small ms-1">#${c.num}</span>` : ''

            tr.innerHTML = `
                    <td class="text-muted fw-bold small">${i + 1}</td>
                    <td>
                        <div class="col-card-name">${c.nome}</div>
                        <div class="d-block d-md-none mt-1">${setBadge} ${numDisplay} ${extraBadge}</div>
                        <div class="d-none d-md-inline-block">${extraBadge}</div>
                    </td>
                    <td class="text-center d-none d-md-table-cell">${setBadge}<div class="mt-1">${numDisplay}</div></td>
                    <td class="text-end fw-bold text-white">${BRL.format(c.total)}</td>
                `
            tbodyTop.appendChild(tr)
          })

          const tbodyMovers = document.getElementById('tableMovers')
          if (data.maioresMovimentacoes.length === 0) {
            tbodyMovers.innerHTML =
              '<tr><td colspan="3" class="text-center text-muted py-3">Mercado estável.</td></tr>'
          } else {
            data.maioresMovimentacoes.forEach(c => {
              const isPos = c.diff > 0
              const colorClass = isPos ? 'var-up' : 'var-down'
              const icon = isPos ? '▲' : '▼'
              const tr = document.createElement('tr')
              const extraBadge = c.extras
                ? `<span class="badge-extra ms-1" style="font-size:0.55rem">${c.extras}</span>`
                : ''

              tr.innerHTML = `
                        <td>
                            <div class="col-card-name">${c.nome}</div>
                            <div class="d-flex align-items-center mt-1">
                                <span class="badge-tech" style="font-size:0.6rem">${c.edicao}</span>
                                ${extraBadge}
                            </div>
                        </td>
                        <td class="text-end fw-bold ${colorClass}" style="font-size:0.9rem">
                            ${icon}${BRL.format(Math.abs(c.diff))}
                        </td>
                    `
              tbodyMovers.appendChild(tr)
            })
          }
        } catch (e) {
          console.error(e)
        }
      }

      initDashboard()
    </script>
  </body>
</html>
